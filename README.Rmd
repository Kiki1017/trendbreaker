---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# epichange

<!-- badges: start -->
[![R build status](https://github.com/reconhub/epichange/workflows/R-CMD-check/badge.svg)](https://github.com/reconhub/epichange/actions)
<!-- badges: end -->

The *epichange* package implements tools for detecting changes in temporal
trends of a single response variable. It provides a coherent interface to
several modeling tools, alonside functions for model selection and outlier
detection. It implements the **A**utomatic **S**election of **M**odels and
**O**utlier **De**tection for **E**pidemmics (ASMODEE), an algorithm originally
designed for detecting changes in COVID-19 case incidence. 

ASMODEE proceeds by:

1. defining a training set excluding the last *k* data points
2. identifying the temporal trend in the training set by fitting a range of
   (user-specified) models to the data and retaining the best predicting /
   fitting model
3. calculating the prediction interval (PI) of the temporal trend
4. classifying any data point outside the PI as outlier

The algorithm can be applied with fixed, user-specified value of *k*, so as to
monitor potential changes in this recent time period. Alternatively, the optimal
value of *k* can be determined automatically.

**Disclaimer:** this is work in progress. Please reach out to the authors before
using this package. Also note this package may soon be renamed to avoid clashes
with other projects and reflect a more general scope.


## Getting started

You can install the released version of epichange from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("epichange")
```

And the development version from [GitHub](https://github.com/) with:

``` r
if (!require(remotes)) {
  install.packages("remotes")
}
remotes::install_github("reconhub/epichange")
```

The best place to start for using this package is to read the documentation of
the function `asmodee` and run its example:

```{r eval = FALSE}
library(epichange)
?asmodee
example(asmodee)
```


## Main features

The package implements the following main functions

* `asmodee`: implements the Automatic Selection of Models and Outlier DEtection
  for Epidemics
  
* `select_model`: a function to select the best-fitting/best-predicting model
  from a range of user-specified models
  
* `detect_changepoint`: a function to detect the points at which recent data
  deviate from previous temporal trends using a fitted model and
  data

* `detect_outliers`: a function to identify outliers using a fitted model and
  data
  


### ASMODEE

We illustrate 

```{r asmodee}
if (require(cowplot) && require(tidyverse)) {
  # load data
  data(nhs_pathways_covid19)

  # select last 28 days
  first_date <- max(nhs_pathways_covid19$date, na.rm = TRUE) - 28
  pathways_recent <- nhs_pathways_covid19 %>%
    filter(date >= first_date)
  
  # define candidate models
  models <- list(
    regression = lm_model(count ~ day),
    poisson_constant = glm_model(count ~ 1, family = "poisson"),
    negbin_time = glm_nb_model(count ~ day),
    negbin_time_weekday = glm_nb_model(count ~ day + weekday)
  )

  # analyses on all data
  counts_overall <- pathways_recent %>%
    group_by(date, day, weekday) %>%
    summarise(count = sum(count))

  # results with automated detection of 'k'
  res_overall <- asmodee(counts_overall, models, method = evaluate_aic)
  res_overall
  plot(res_overall, "date")

  # results with fixed value of 'k' (7 days)
  res_overall_k7 <- asmodee(counts_overall, models, fixed_k = 7)
  plot(res_overall_k7, "date")

  # analyses by NHS regions
  counts_nhs_region <- pathways_recent %>%
    group_by(nhs_region, date, day, weekday) %>%
    summarise(count = sum(count)) %>%
    complete(date, fill = list(count = 0)) %>% 
    split(.$nhs_region)

  res_nhs_region <- lapply(counts_nhs_region,
                           asmodee,
                           models,
                           method = evaluate_aic,
                           alpha = 0.05)

  plots_nhs_region <- lapply(seq_along(res_nhs_region),
                             function(i)
                               plot(res_nhs_region[[i]], "date", point_size = 1, guide = FALSE) +
                                 labs(subtitle = names(res_nhs_region)[i], x = NULL))
  cowplot::plot_grid(plotlist = plots_nhs_region)

}

```

### Model selection

You can define a number of different regression models using a common interface.
Once defined you can use different strategies to select the
best-fitting/best-predicting model.

As an example we try to predict `hp` of the famous `mtcars` dataset.  Of course,
this is just a toy example. Usually you would use the package to predict counts
data in a time series.

First we define some potential models:
```{r}
library(epichange)
stan_cache <- tempfile() # stan compile to c++ and we cache the code
models <- list(
  null = lm_model(hp ~ 1),
  glm_poisson = glm_model(hp ~ 1 + cyl + drat + wt + qsec + am, poisson),
  lm_complex = lm_model(hp ~ 1 + cyl + drat + wt + qsec + am),
  negbin_complex = glm_nb_model(hp ~ 1 + cyl + drat + wt + qsec + am),
  brms_complex = brms_model(
    hp ~ 1 + cyl + drat + wt + qsec + am,
    family = brms::negbinomial(),
    file = stan_cache
  )
)
```

Then we evaluate them using [N-Fold cross validation](https://en.wikipedia.org/wiki/Cross-validation_(statistics)).

```{r, message=FALSE, warning=FALSE}
# we do CV and evaluate three loss function:
# Root-mean-squared error, the huber-loss and mean absolute error.
# The package works with `yardstick` by default.
out <- capture.output( # no log output in readme :)
  auto_select <- select_model(mtcars, models,
    method = evaluate_resampling,
    metrics = list(yardstick::rmse, yardstick::huber_loss, yardstick::mae)
  )
)
auto_select$leaderboard
```
